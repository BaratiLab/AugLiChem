<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Usage | AugLiChem</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Usage" />
<meta name="author" content="BaratiLab" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="AugLiChem supports data augmentation for organic and inorganic systems. Pre-defined augmentations, built-in data downloading, automatic data cleaning, and pre-implemented models make AugLiChem easy to use." />
<meta property="og:description" content="AugLiChem supports data augmentation for organic and inorganic systems. Pre-defined augmentations, built-in data downloading, automatic data cleaning, and pre-implemented models make AugLiChem easy to use." />
<link rel="canonical" href="http://localhost:4000/usage_guide/" />
<meta property="og:url" content="http://localhost:4000/usage_guide/" />
<meta property="og:site_name" content="AugLiChem" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Usage" />
<script type="application/ld+json">
{"url":"http://localhost:4000/usage_guide/","headline":"Usage","author":{"@type":"Person","name":"BaratiLab"},"description":"AugLiChem supports data augmentation for organic and inorganic systems. Pre-defined augmentations, built-in data downloading, automatic data cleaning, and pre-implemented models make AugLiChem easy to use.","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="AugLiChem" /></head>
<body><div class="site-sidebar">

    <a class="sidebar-title" href="/">
    <img src="images/logo.png" alt="drawing" width="20"/>
	    AugLiChem

    <img src="images/Project.png" alt="drawing" width="20"/>
    </a>

    
    
    <!--  -->
    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
            <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
            <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
          </svg>
        </span>
      </label>

      <form class="trigger" method="get" action="/search">
        <input type="text" name="q" placeholder="Search blog">
      </form>

      <ul id="page-list" class="trigger sidebar-list">
        
          
          
        
          
          
            <li class=""><a href="/about.html">About</a></li>
          
        
          
          
            <li class=""><a href="/crystal.html">Crystal</a></li>
          
        
          
          
            <li class=""><a href="/crystal_usage.html">Crystal Usage</a></li>
          
        
          
          
            <li class=""><a href="/molecule.html">Molecule</a></li>
          
        
          
          
            <li class=""><a href="/molecule_usage.html">Molecule Usage</a></li>
          
        
          
          
            <li class=""><a href="/install_guide.html">Installation</a></li>
          
        
      </ul>
    <!--  -->

      
        <ul id="post-list" class="trigger sidebar-list">
          
            <li class="">
              
              <span>Oct 29, 2021</span><br>
              <a href="/2021/10/29/release.html">Release</a>
            </li>
          
        </ul>
      
    </nav>

</div>
<div class="main-wrapper"><header class="site-header" role="banner">

  <div class="wrapper">
    <a class="site-title" rel="author" href="/">
	    AugLiChem
    </a>
  </div>
</header>
<main class="page-content" aria-label="Content">
        <div class="wrapper">
          <article class="post">

  <header class="post-header">
    <h1 class="post-title">Usage</h1>
  </header>

  <div class="post-content">
    <p>AugLiChem has been designed from the ground up with ease-of-use in mind.
Fully functional notebooks are available at our github in the <code class="language-plaintext highlighter-rouge">examples/</code> directory <a href="https://github.com/BaratiLab/AugLiChem/tree/main/examples">here</a>.
In-depth documentation of each function is given in the docstrings and can be printed out using python’s built-in <code class="language-plaintext highlighter-rouge">help()</code> function.
Using PyTorch’s CUDA support, all models and data sets can be used with GPUs.</p>

<h2 id="molecule-usage">Molecule Usage</h2>

<p>The first step is to import the relevant modules.
AugLiChem is largely self-contained, and so we import transformations, data wrapper, and models.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from auglichem.molecule import RandomAtomMask, RandomBondDelete, MotifRemoval
from auglichem.molecule.data import MoleculeDatasetWrapper
from auglichem.molecule.models import AttentiveFP as afp
</code></pre></div></div>

<p>Next, we set up our transformations.
Transformations can be set up as a list or single transformation.
When using a list, each molecule is transformed by all transformations passed in.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>transforms = [
      RandomAtomMask([0.1,0.3]),
      RandomBondDelete([0.1, 0.4]),
      MotifRemoval(0.6)
]
</code></pre></div></div>
<p>RandomAtomMask and RandomBondDelete take in either a list of two number, or a single number, which represents the fraction of atoms to mask and bonds to delete, respectively.
When a list is passed in, a number is sampled uniformly between the two values for each molecule and used for the masking/deletion fraction.
MotifRemoval is deterministic, and uses a similarity score between motifs and the original molecule.
Motifs that are above the similarity score threshold, the passed in parameter, are retained for the augmented molecule data.</p>

<p>After initializing our transformations, we are ready to initialize our data set.
Data sets are selected with a string, and are automatically downloaded to <code class="language-plaintext highlighter-rouge">./data_download</code> by default.
This directory is created if it is not present, and does not download the data again if it is already present.
Batch size, validation size, and test size for training and evaluation are set here.
The transforms are passed in here and scaffold splitting is supported.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dataset = MoleculeDatasetWrapper("ClinTox", transform=transforms, batch_size=128, valid_size=0.1, test_size=0.1)
</code></pre></div></div>

<p>Using the wrapper class is preferred for easy training because of the data loader function, which creates pytorch-geometric data loaders that are easy to iterate over.
With multi-target data sets, such as ClinTox, we specify the target we want here.
If no target is selected, the first target in the downloaded data file is used.
Multiple targets can be selected for multi-target training by passing in a list of targets, or ‘all’ to use all of them.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>train_loader, valid_loader, test_loader = dataset.get_data_loaders("FDA_APPROVED")
</code></pre></div></div>

<p>Now that our data is ready for training and evalutaion, we initialize our model.
Task, either regression or classification needs to be passed in.
Our dataset object stores this in the <code class="language-plaintext highlighter-rouge">task</code> attribute.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>model = afp(task=dataset.task)
</code></pre></div></div>

<p>From here, we are ready to train using standard PyTorch training procedure.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import torch
criterion = torch.nn.CrossEntropyLoss()
optimizer = torch.optim.Adam(model.parameters(), lr=1e-3, weight_decay=1e-5)
</code></pre></div></div>

<p>Now we have our training loop.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for epoch in range(100):
    for bn, data in tqdm(enumerate(train_loader)):

        optimizer.zero_grad()
        
        _, pred = model(data)
        loss = criterion(pred, data.y.flatten())

        loss.backward()
        optimizer.step()
</code></pre></div></div>

<p>Evaluation requires storing all predections and labels for each batch, and so we have</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from sklearn.metrics import roc_auc_score

with torch.no_grad():
    model.eval()
        
   all_preds = []
    all_labels = []
    for data in test_loader:
        _, pred = model(data)

        # Hold on to all predictions and labels
        all_preds.extend(pred[:,1])
        all_labels.extend(data.y)
    
    metric = roc_auc_score(data.y.cpu(), pred.cpu().detach()[:,1])
    print("TEST ROC: {1:.3f}".format(metric))
</code></pre></div></div>

<h2 id="crystal-usage">Crystal Usage</h2>

<p>Using the crystal submodule is very similar to molecule.</p>

<p>The first step is to import the relevant modules.
AugLiChem is largely self-contained, and so we import transformations, data wrapper, and models.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from auglichem.crystal import RotationTransformation, PerturbStructureTransformation
from auglichem.crystal.data import CrystalDatasetWrapper
from auglichem.crystal.models import SchNet
</code></pre></div></div>

<p>Next, we set up our transformations.
Transformations can be set up as a list or single transformation.
When using a list, each molecule is transformed by all transformations passed in.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>transforms = [
	RotationTransformation(),
	PerturbStructureTransformation()
]
</code></pre></div></div>
<p>RandomAtomMask and RandomBondDelete take in either a list of two number, or a single number, which represents the fraction of atoms to mask and bonds to delete, respectively.
When a list is passed in, a number is sampled uniformly between the two values for each molecule and used for the masking/deletion fraction.
MotifRemoval is deterministic, and uses a similarity score between motifs and the original molecule.
Motifs that are above the similarity score threshold, the passed in parameter, are retained for the augmented molecule data.</p>

<p>After initializing our transformations, we are ready to initialize our data set.
Data sets are selected with a string, and are automatically downloaded to <code class="language-plaintext highlighter-rouge">./data_download</code> by default.
This directory is created if it is not present, and does not download the data again if it is already present.
Batch size, validation size, and test size for training and evaluation are set here.
Unlike molecule, CrystalDatasetWrapper handles transformations when splitting the data.
Random splitting, and k-fold cross validation are supported.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dataset = CrystalDatasetWrapper("lanthanides", batch_size=128, valid_size=0.1, test_size=0.1)
</code></pre></div></div>

<p>Using the wrapper class is necessary for easy training in the crystal sets because of the data loader function, which creates pytorch-geometric data loaders that are easy to iterate over.
Crystal data sets are augmented when getting the data loaders and augmented CIF files are stored next to the originals.
Loading original or augmented CIF files is handled automatically by the loaders, where only the training set uses the augmented files.
Note: this function call may take a while the first time due to loading, transforming, and saving thousands of files. However, if augmented files are present, they will not be augmented again, and running the code again will be significantly faster.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>train_loader, valid_loader, test_loader = dataset.get_data_loaders(transform=transforms)
</code></pre></div></div>

<p>Now that our data is ready for training and evalutaion, we initialize our model.
Task, either regression or classification needs to be passed in.
Our dataset object stores this in the <code class="language-plaintext highlighter-rouge">task</code> attribute.
Note: CGCNN uses a different implementation and needs to be initialized and trained differently.
A working example of this is given in <code class="language-plaintext highlighter-rouge">examples/</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>model = SchNet(task=dataset.task)
</code></pre></div></div>

<p>From here, we are ready to train using standard PyTorch training procedure.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import torch
criterion = torch.nn.MSELoss()
optimizer = torch.optim.Adam(model.parameters(), lr=1e-3, weight_decay=1e-5)
</code></pre></div></div>

<p>Now we have our training loop. Pymatgen throws a lot of warnings, which we suppress.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>with warnings.catch_warnings():
    warnings.simplefilter("ignore")
    for epoch in range(1):
        for bn, data in tqdm(enumerate(train_loader)):        
            optimizer.zero_grad()

            # Comment out the following line and uncomment the line after for cuda
            pred = model(data)
            #pred = model(data.cuda())
            
            loss = criterion(pred, data.y)

            loss.backward()
            optimizer.step()
</code></pre></div></div>

<p>Evaluation requires storing all predections and labels for each batch, and so we have:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from sklearn.metrics import mean_absolute_error 

with warnings.catch_warnings():
    warnings.simplefilter("ignore")
    with torch.no_grad():
        model.eval()
        preds = torch.Tensor([])
        targets = torch.Tensor([])
        for data in test_loader:
            #pred = model(data)
            pred = model(data.cuda())
            preds = torch.cat((preds, pred.cpu()))
            targets = torch.cat((targets, data.y.cpu()))

        mae = mean_absolute_error(preds, targets)   
    
    set_str = "VALIDATION" if(validation) else "TEST"
    print("{0} MAE: {1:.3f}".format(set_str, mae))
</code></pre></div></div>

  </div>

</article>

        </div>
      </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">AugLiChem</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">BaratiLab</li><li><a class="u-email" href="mailto:your-email@domain.com">your-email@domain.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/BaratiLab"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">BaratiLab</span></a></li><li><a href="https://www.twitter.com/AmirBaratiF"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">AmirBaratiF</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>AugLiChem supports data augmentation for organic and inorganic systems. Pre-defined augmentations, built-in data downloading, automatic data cleaning, and pre-implemented models make AugLiChem easy to use.
</p>
      </div>
    </div>

  </div>

</footer>
</div>

    <script>
      (function() {

        var postList = document.getElementById('post-list');
	      var activePost = postList.getElementsByClassName('active')[0];

        var post = document.getElementsByClassName('post-content')[0];

        var headings = [];

        var tag_names = {
            h1:1,
            h2:1,
            h3:1,
            h4:1,
            h5:1,
            h6:1
        };

        function walk(root) {
            if (root.nodeType === 1 && root.nodeName !== 'script') {
                if (tag_names.hasOwnProperty(root.nodeName.toLowerCase())) {
                    headings.push(root);
                } else {
                    for (var i = 0; i < root.childNodes.length; i++) {
                        walk(root.childNodes[i]);
                    }
                }
            }
        }

        walk(post);

        if (headings.length > 0) {
          var ul = document.createElement("ul");
          ul.classList.add("sidebar-headings")
          activePost.appendChild(ul);

          for (var i=0, max=headings.length; i < max; i++) {
            var li = document.createElement("li");
            li.classList.add("sidebar-" + headings[i].tagName.toLowerCase());
            var a = document.createElement("a");
            var aText = document.createTextNode(headings[i].innerText);
            a.appendChild(aText);
            a.href = "#" + headings[i].id;
            li.appendChild(a);
            ul.appendChild(li);
          }
        }

      })();
    </script>

  </body>

</html>
